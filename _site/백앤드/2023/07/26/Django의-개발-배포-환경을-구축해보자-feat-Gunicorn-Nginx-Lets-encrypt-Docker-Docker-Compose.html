<!DOCTYPE html>
<html lang="en"><head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="bdg-blog" /></head>
<style>@import url(/public/css/syntax/monokai.css);</style>
  <title>bdg-blog</title>
  <!-- <link href="/public/css/bootstrap.min.css" rel="stylesheet"> -->

  <link href="/public/css/style.css" rel="stylesheet">
  <body>
  	<div class="container"> 
		<div class="sidebar">
			<div class="sidebar-item sidebar-header">
	<div class='sidebar-brand'>
		<a href="/">bdg-blog</a>
	</div>
	<p class="lead"></p></div>

<div class="sidebar-item sidebar-nav">
	<ul class="nav">
      <li class="nav-title">Pages</li>
	  <li>
	  	<a class="nav-item" href="/">Articles</a>
	  </li>
	  
	  
	    
	  
	    
	      
	    
	  
	    
	  
	    
	  
	</ul>
</div>

<div class="sidebar-item sidebar-nav">
  	<ul class="nav">
			<li class="nav-title">Categories</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#쿠버네티스">
				<span class="name">쿠버네티스</span>
				<span class="badge">10</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#기타">
				<span class="name">기타</span>
				<span class="badge">8</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#운영체제/컴퓨터구조">
				<span class="name">운영체제/컴퓨터구조</span>
				<span class="badge">7</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#백앤드">
				<span class="name">백앤드</span>
				<span class="badge">5</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#컨테이너">
				<span class="name">컨테이너</span>
				<span class="badge">2</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#Go">
				<span class="name">Go</span>
				<span class="badge">6</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#클린 아키텍쳐">
				<span class="name">클린 아키텍쳐</span>
				<span class="badge">2</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#보안">
				<span class="name">보안</span>
				<span class="badge">2</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#리눅스">
				<span class="name">리눅스</span>
				<span class="badge">1</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#네트워크">
				<span class="name">네트워크</span>
				<span class="badge">4</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#자바스크립트">
				<span class="name">자바스크립트</span>
				<span class="badge">1</span>
	    	</a>
 		</li>
	    
	    <li>
	    	<a class="nav-item" href="/category/#클린 코드">
				<span class="name">클린 코드</span>
				<span class="badge">1</span>
	    	</a>
 		</li>
	    
	  </nav>
	</ul>
</div>

<div class="sidebar-item sidebar-footer">
</div>
		</div>
		<div class="content">
			<article class="post">
	<header class="post-header">
		<div class="post-title"> 
			Django의 개발 / 배포 환경을 구축해보자. (feat, Gunicorn, Nginx, Let&#39;s encrypt, Docker, Docker Compose)
		</div>
		<time class="post-date dt-published" datetime="2023-07-26T19:26:56+09:00" itemprop="datePublished">2023/07/26
		</time>		
	</header>

	<div class="post-content">
		<p><img alt="image" src="/images/ecd42fef-1bd1-4423-9135-c77e73eeea90" /></p>

<h2 id="i-개요">I. 개요</h2>

<p>이 포스트에서는 Django의 개발 및 배포환경을 구축하는 방법에 대해 소개한다. 우리가 개발을 하다보면 다음과 같은 문제로 스트레스를 받는다.</p>

<ul>
  <li>윈도우의 개발환경과 리눅스의 배포환경이 달라서 에러가 발생하거나</li>
  <li>Https를 연결하는 작업에 비용을 지불하거나</li>
  <li>Let’s encrypt를 적용하면서 많은 시간을 쓰거나</li>
  <li>설마 디버거 안 써..?</li>
</ul>

<p>docker와 docke-compose를 통해서 이러한 문제를 하나씩 해결해보자.</p>

<h3 id="docker란">docker란?</h3>

<blockquote>
  <p><em>도커는 container라고 불리는 고립된 환경에서 하나의 어플리케이션을 패키징하는 능력을 제공한다. 이러한 어플리케이션의 컨테이너화는 하나의 host에서 여러개의 컨테이너를 동시에 병렬적으로 실행할 수 있게 도와준다.  - docker docs</em></p>

</blockquote>

<h3 id="docker-compose란">docker-compose란?</h3>

<blockquote>
  <p><em>Compose란 여러개의 도커 컨테이너를 “정의”하고 “실행”하는 도구이다. - docker docs</em></p>

</blockquote>

<p>Docker를 통해서 Proxy서버 컨테이너, Django 서버 컨테이너, Let’s encrypt 컨테이너를 분리하고 이를 하나의 compose파일에 정의해서 <code class="highlighter-rouge">docker-compose -f docker-compose.prod.yml up</code> 라는 명령만으로 배포를 위해 필요한 작업들인 https 붙이는 작업, Gunicorn을 세팅하고 데몬화 하는 작업을 모두 자동화하고자 한다.</p>

<p>여기에 더해서 개발 전용 compose파일을 정의해서  <code class="highlighter-rouge">docker-compose -f docker-compose.dev.yml up</code> 이라는 명령어를 실행하고 몇가지 vscode 세팅을 한다면 배포환경과 매우 유사한 개발 전용 컨테이너까지 만들겠다.</p>

<h2 id="i-폴더-구조">I. 폴더 구조</h2>

<p>다음과 같이 api 폴더를 구성한다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>api
│  .gitignore
│  .proxy-companion.prod.env <span class="c"># 배포용에서 사용되는 nginx-proxy container 환경변수</span>
│  backend.dev.env <span class="c"># 개발용 컨테이너 환경 변수</span>
│  backend.prod.env <span class="c"># 배포용 컨테이너 환경 변수</span>
│  docker-compose.dev.yml <span class="c"># 개발용 docker-compose 파일</span>
│  docker-compose.prod.yml <span class="c"># 배포용 docker-compose 파일</span>
│  Dockerfile
│  README.md
│
├─dev-vscode
│      launch.json <span class="c"># Dajngo 디버거를 정의</span>
│      settings.json <span class="c"># pylint, default python path등 vscode 세팅 정의</span>
│
├─nginx // nginx-proxy 컨테이너
│  │  custom.conf <span class="c"># nginx-proxy 컨테이너의 nginx  conf.d 파일</span>
│  │  Dockerfile <span class="c"># custom.conf와 vhost.d 를 컨테이너 내부로 COPY</span>
│  │
│  └─vhost.d
│          default <span class="c"># nginx-proxy 컨테이너의 nginx default 파일</span>
│
└─src <span class="c"># Django의 소스 코드 </span>
	  <span class="c"># docker ignore를 통해서 분리할 수도 있지만 이런식으로 이미지속에 들어가는 소스 코드는 따로 분리하는 것을 선호한다.</span>
    │  manage.py
    │  requirements.txt
    │
    ├─accounts
    │  │  admin.py
    │  │  apps.py
    │  │  mangers.py
    │  │  models.py
    │  │  permissions.py
    │  │  serializers.py
    │  │  urls.py
    │  │  views.py
    │  │  __init__.py
    │  │
    │  └─migrations
    │          0001_initial.py
    │          __init__.py
    │
    ├─post
    │  │  admin.py
    │  │  apps.py
    │  │  models.py
    │  │  tests.py
    │  │  views.py
    │  │  __init__.py
    │  │
    │  └─migrations
    │          __init__.py
    │
    └─project <span class="c"># settings.py가 들어있는 django의 메인 폴더</span>
            asgi.py
            routing.py
            settings.py
            urls.py
            wsgi.py
            __init__.py
</code></pre></div></div>

<h2 id="ii-개발-환경-세팅">II. 개발 환경 세팅</h2>

<h3 id="1-코드">1. 코드</h3>

<ul>
  <li>docker-compose.dev.yml 파일 정의</li>
</ul>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">backend-dev</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">backend-dev</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">./Dockerfile</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./src:/workdir/src</span> <span class="c1"># 개발중에는 소스코드를 외부와 마운트해서 사용한다.</span>
      <span class="pi">-</span> <span class="s">./dev-vscode:/workdir/.vscode# 미리 정의해둔 settings.json과 launch.json</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">bash -c "cd /workdir/src &amp;&amp; python -m pip install -r requirements.txt"</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">8000:8000</span>
    <span class="na">env_file</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./backend.dev.env# 개발에서 쓰이는 환경변수</span>
    <span class="na">stdin_open</span><span class="pi">:</span> <span class="no">true</span> <span class="c1"># docker run -i</span>
    <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span> <span class="c1"># docker run -t</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">/bin/bash'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">-c'</span><span class="pi">]</span> <span class="c1"># /bin/bash를 띄워서 커널이 죽지 않도록 설정.</span>
</code></pre></div></div>

<ul>
  <li>backend.dev.env 파일 정의</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SITE_ID</span><span class="o">=</span>1
<span class="nv">DEBUG</span><span class="o">=</span>1
<span class="nv">HTTPS</span><span class="o">=</span>0
<span class="nv">DJANGO_ALLOWED_HOSTS</span><span class="o">=</span>localhost 127.0.0.1 <span class="o">[</span>::1] 0.0.0.0
<span class="nv">VIRTUAL_PORT</span><span class="o">=</span>8000
<span class="nv">SECRET_KEY</span><span class="o">=</span>&lt;django에서 생성하는 secret&gt;
</code></pre></div></div>

<ul>
  <li><a href="http://settings.py">settings.py</a> 수정</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span> 

<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"SECRET_KEY"</span><span class="p">)</span>

<span class="c1"># site id
</span><span class="n">SITE_ID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"SITE_ID"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># debug option
</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"DEBUG"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># allowed host
</span><span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"DJANGO_ALLOWED_HOSTS"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"*"</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>

<span class="c1"># state
</span><span class="n">STATE</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"STATE"</span><span class="p">)</span>

<span class="c1"># for https
</span><span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"HTTPS"</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">SECURE_PROXY_SSL_HEADER</span> <span class="o">=</span> <span class="p">(</span><span class="s">"HTTP_X_FORWARDED_PROTO"</span><span class="p">,</span> <span class="s">"https"</span><span class="p">)</span>
    <span class="n">USE_X_FORWARDED_HOST</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SECURE_SSL_REDIRECT</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># http로 들어오면 https 로 redirect
</span></code></pre></div></div>

<ul>
  <li>
    <p>dev-vscode/launch.json 생성</p>

    <p>print함수 등을 통해서 코드 중간 중간 변수값을 확인할 수 있지만 vscode의 훌륭한 debuger를 사용한다면 더 편하게 디버깅을 수행할 수 있다. 처음 세팅이 귀찮더라도 한 번 설정하면 그 다음 작업이 매우 편해지기 때문에 디버거 설정을 추가한다.</p>

    <ul>
      <li>컨테이너 외부에서 접근하기 때문에 0.0.0.0:8000 옵션을 추가해야함.</li>
    </ul>
  </li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//launch.json</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Python: Django"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"launch"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NULL/backend/manage.py"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"runserver"</span><span class="p">,</span><span class="w"> </span><span class="s2">"0.0.0.0:8000"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"django"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">//settings.json</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"python.defaultInterpreterPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/local/bin/python"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"python.pythonPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/local/bin/python"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"python.linting.pylintEnabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"python.linting.enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>Dcokerfile</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># pull official base image</span>
FROM python:3.8-slim-buster

<span class="c">#set environment variables</span>
<span class="c"># I don't want to generate pcy files</span>
ENV PYTHONDONTWRITEBYTECODE 1
<span class="c"># ignore buffering</span>
ENV PYTHONUNBUFFERED 1
<span class="c"># set encoding</span>
ENV PPYTHONENCODING utf-8

<span class="c">#set work directory</span>
WORKDIR /workdir

<span class="c"># for mysql, django의 DB로 msyql을 사용하지 않는다면 굳이 필요없다.</span>
RUN apt-get update
RUN apt-get <span class="nb">install </span>python3-dev default-libmysqlclient-dev gcc  <span class="nt">-y</span>

<span class="c"># 배포할 경우 프로젝트 코드를 모두 도커 이미지에 넣는다.</span>
COPY ./src /workdir/src

<span class="c"># python dependencies</span>
RUN pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip
RUN pip <span class="nb">install </span>django
RUN pip <span class="nb">install </span>gunicorn
RUN pip <span class="nb">install</span> <span class="nt">-r</span> /workdir/src/requirements.txt
</code></pre></div></div>

<h3 id="2-docker-compose-up">2. docker-compose up</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose <span class="nt">-f</span> .<span class="se">\d</span>ocker-compose.dev.yml up <span class="nt">-d</span> <span class="nt">--build</span>

<span class="c"># -f .\docker-compose.dev.yml : .\docker-compose.dev.yml파일 실행</span>
<span class="c"># -d: 백그라운드에서 실행</span>
<span class="c"># --build: 실행전에 이미지 빌드</span>
</code></pre></div></div>

<h3 id="3-다시-시작할-때">3. 다시 시작할 때</h3>

<ol>
  <li>root 폴더에서 터미널 실행 후 docker-compose up</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose <span class="nt">-f</span> .<span class="se">\d</span>ocker-compose.dev.yml up <span class="nt">-d</span> <span class="nt">--build</span>
</code></pre></div></div>

<ol>
  <li>Attach Visual Studio Code</li>
</ol>

<p><img alt="image" src="/images/d8b954cd-cc89-4462-9807-e7480cd0a82b" /></p>

<ol>
  <li>/workdir 경로의 폴더를 open</li>
</ol>

<p><img alt="image" src="/images/cdea7926-d077-4e67-8247-d0bda13239de" /></p>

<ol>
  <li>디버거 실행</li>
</ol>

<p><img alt="image" src="/images/039e4024-9e82-490d-9cee-a5f35a5c043f" /></p>

<ol>
  <li>개발!</li>
</ol>

<h2 id="ii-배포-환경-세팅">II. 배포 환경 세팅</h2>

<h3 id="1-코드-1">1. 코드</h3>

<ul>
  <li>docker-compose.prod.yml 파일 정의</li>
</ul>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">backend-prod</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">backend-prod</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">./Dockerfile</span>
      <span class="c1"># workers는 무조건 2개 이상 설정하는 것을 권장한다.</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">bash -c "cd ./src &amp;&amp; gunicorn --workers=3 --bind 0.0.0.0:8000 --preload project.wsgi:application"</span>
    <span class="na">expose</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="m">8000</span>
    <span class="na">env_file</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./backend.prod.env</span>

  <span class="na">nginx-proxy</span><span class="pi">:</span> <span class="c1"># proxy 컨테이너</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">nginx-proxy</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">./nginx</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">80:80</span>
      <span class="pi">-</span> <span class="s">443:443</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./backend:/workdir/backend</span>
      <span class="pi">-</span> <span class="s">./nginx/custom.conf:/etc/nginx/conf.d/custom.conf</span>
      <span class="pi">-</span> <span class="s">certs:/etc/nginx/certs</span>
      <span class="pi">-</span> <span class="s">html:/usr/share/nginx/html</span>
      <span class="pi">-</span> <span class="s">vhost:/etc/nginx/vhost.d</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/tmp/docker.sock:ro</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">backend-prod</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy</span>

<span class="c1"># letsencrypt 인증서를 발급 및 관리하는 컨테이너</span>
<span class="c1"># 사전에 도메인을 발급받아 연결하는 작업이 필요하다.</span>
  <span class="na">letsencrypt</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginxproxy/acme-companion</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">letsencrypt</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nginx-proxy</span>
    <span class="na">volumes</span><span class="pi">:</span>
<span class="err">	</span><span class="c1"># letsencrypt는 DinD(Docker In Docker)기술이 사용된다.</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock:ro</span>
      <span class="pi">-</span> <span class="s">certs:/etc/nginx/certs</span>
      <span class="pi">-</span> <span class="s">html:/usr/share/nginx/html</span>
      <span class="pi">-</span> <span class="s">vhost:/etc/nginx/vhost.d</span>
      <span class="pi">-</span> <span class="s">acme:/etc/acme.sh</span>
    <span class="na">env_file</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">.proxy-companion.prod.env</span>
    
  <span class="na">redis-chat</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">redis-chat</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">6379:6379</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">redis-server</span>
    <span class="na">healthcheck</span><span class="pi">:</span>
      <span class="na">test</span><span class="pi">:</span> <span class="s1">'</span><span class="s">redis-cli</span><span class="nv"> </span><span class="s">-h</span><span class="nv"> </span><span class="s">127.0.0.1</span><span class="nv"> </span><span class="s">ping'</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="s">3s</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="s">1s</span>
      <span class="na">retries</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">certs</span><span class="pi">:</span>
  <span class="na">html</span><span class="pi">:</span>
  <span class="na">vhost</span><span class="pi">:</span>
  <span class="na">acme</span><span class="pi">:</span>
  
</code></pre></div></div>
<ul>
  <li>letsencrypt 컨테이너
    <ul>
      <li>letsencrypt는 TLS 인증서를 발급해주는 비영리기관으로 https에 사용되는 TLS인증서가 필요하다면 letsencrypt는 매우 합리적인 방법이다.</li>
      <li>다른 유로 인증기관이 보증하는 것처럼 사이트와 사이트 이용자간에 이동하는 데이터 변조나 데이터 가로채기에 있어 안전함을 보장한다.</li>
      <li>TLS 인증 자체가 그 사이트가 안전함을 보장하지 않는다.</li>
      <li>letsencrypt는 DinD(Docker In Docker)기술이 사용된다. letsencrypt 컨테이너 속에서 다른 컨테이너의 환경변수를 확인하고 LETSENCRYPT_HOST의 값에 따라 인증서를 결정한다.</li>
      <li>nginx-proxy서버 또한 DinD을 통해 다른 컨테이너의 환경변수를 확인하고 VIRTUAL_HOST에 따라 외부 요청을 포워딩하는 proxy 서버의 역할을 수행한다.</li>
    </ul>
  </li>
  <li>backend.prod.env 파일 정의</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SITE_ID</span><span class="o">=</span>2
<span class="nv">DEBUG</span><span class="o">=</span>0
<span class="nv">HTTPS</span><span class="o">=</span>0
<span class="nv">DJANGO_ALLOWED_HOSTS</span><span class="o">=</span>https://prod.domin.com host서버이름2 host서버이름3
<span class="nv">VIRTUAL_HOST</span><span class="o">=</span>prod.domin.com
<span class="nv">VIRTUAL_PORT</span><span class="o">=</span>8000
<span class="nv">SECRET_KEY</span><span class="o">=</span>django-insecure-bdmgpgpdmgpgpdmgpa이것은시크릿키askdljflk
<span class="nv">LETSENCRYPT_HOST</span><span class="o">=</span>prod.domin.com
</code></pre></div></div>

<h2 id="2-배포">2. 배포</h2>

<p>세팅이 완료되었다면 다음 한 줄로 인증서 작업, 데몬화, 배포를 모두 자동화 할 수 있다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose <span class="nt">-f</span> .<span class="se">\d</span>ocker-compose.prod.yml up <span class="nt">-d</span> <span class="nt">--build</span>
</code></pre></div></div>

<p>만약 프론트(뷰, 리액트, 장고 스태틱)을 배포하고 싶다면 docker-compose.prod.yml 파일에 프론트 서버용 컨테이너 추가하면된다.</p>

	</div>
	<br/>
	<br/>
	<script src="https://utteranc.es/client.js"
        repo="deagwon97/deagwon97.github.io"
        issue-term="url"
        theme="github-light"
        crossorigin="anonymous"
        async>
	</script>
</article>
		</div>
	</div>
  </body>
</html>